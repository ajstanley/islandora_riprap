<?php

/**
* Implements hook_theme().
*/
function islandora_riprap_theme($existing, $type, $theme, $path) {
 return [
    'islandora_riprap_summary' => [
      'variables' => ['content' => null, 'outcome' => null, 'mid' => null],
    ],
    'islandora_riprap_report' => [
      'variables' => ['report' => null, 'mid' => null, 'binary_resource_url' => null],
    ],
  ];
}

/**
* Default preprocessor function for the islandora_riprap_theme hook.
*/
function template_preprocess_islandora_riprap_report(&$variables) {
  $variables['attributes'] = [
    'id' => ['islandora_riprap_report'],
  ];
}

/**
* Default preprocessor function for the islandora_riprap_theme hook.
*/
function template_preprocess_islandora_riprap_summary(&$variables) {
  $variables['attributes'] = [
    'class' => [$variables['outcome']],
  ];
}

/**
* Implements hook_page_attachments().
*/
function islandora_riprap_page_attachments(array &$attachments) {
  $current_path = \Drupal::service('path.current')->getPath();

  $path_args = explode('/', ltrim($current_path, '/'));
  // E.g., the Manage Media View for each Islandora object.
  if (count($path_args) >= 3 && $path_args[0] == 'node' && $path_args[2] == 'media') {
    $attachments['#attached']['library'][] = 'islandora_riprap/islandora_riprap';
  }

  if ($current_path == '/admin/reports/islandora_riprap') {
    $attachments['#attached']['library'][] = 'islandora_riprap/islandora_riprap_chart';

    $utils = \Drupal::service('islandora_riprap.utils');
    $riprap_data = $utils->getFailedFixityEventsReportData();
    $dataset = new StdClass();
    $dataset->data = array_values($riprap_data);
    $total_failed_events = array_sum($dataset->data);
    if (count($total_failed_events) > 0) {
      $dataset->label = t("$total_failed_events failed fixity check events, broken down by month");
    }
    else {
      unset($dataset->label);
    }
    $dataset->pointBackgroundColor = 'red';
    $dataset->borderColor = 'red';
    $dataset->borderWidth = 1;
    $dataset->pointRadius = 1;
    $dataset->fill = FALSE;
    $dataset->lineTension = 0;
    $line_chart_data = array(
      'labels' => array_keys($riprap_data),
      'datasets' => array($dataset),
    );
    $attachments['#attached']['drupalSettings']['islandora_riprap']['chart_data'] = $line_chart_data;
    if ($total_failed_events == 0) {
      \Drupal::messenger()->addMessage(t('No failed fixity events found.'), 'status');
      \Drupal::logger('islandora_riprap')->info(t('Failed fixity check report has found no events.'));
    }
    else {
      \Drupal::messenger()->addMessage(t('Failed fixity check events found. See monthly summary below.'), 'warning');
      \Drupal::logger('islandora_riprap')->warning(t('Failed fixity check report has found @total events.', ['@total' => $total_failed_events]));
    }
  }
}

/**
 * Implements hook_cron().
 */
function islandora_riprap_cron() {
  $config = \Drupal::config('islandora_riprap.settings');
  $riprap = \Drupal::service('islandora_riprap.riprap');

  if (!$config->get('execute_riprap_in_cron')) {
    return;
  }

  if ($config->get('riprap_mode') == 'local') {
    $success = $riprap->executeRiprapCheckFixity();
  }

  if ($success) {
    \Drupal::logger('islandora_riprap')->info(t('Riprap successfully ran from Drupal cron.'));
  }
  else {
    \Drupal::logger('islandora_riprap')->error(t('Riprap failed to run from Drupal cron.'));
  }

}
